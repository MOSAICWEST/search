<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MOSAIC 재고 검색</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* 공통 스타일 */
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fafafa;
      color: #1f1f1f;
    }
    h1 {
      text-align: center;
      margin: 30px 0 10px;
      font-size: 28px;
      font-weight: 600;
    }
    select, input[type="text"], button {
      font-size: 16px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    input[type="text"]:focus, select:focus {
      border-color: #0071e3;
      box-shadow: 0 0 0 3px rgba(0,113,227,0.2);
    }
    button {
      background-color: #333;
      color: #fff;
      cursor: pointer;
    }
    button:hover { background-color: #555; }
    button:disabled {
      background-color: #ccc;
      color: #666;
      cursor: default;
    }

    /* 검색 및 필터 영역 */
    .search-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 0 5% 30px;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* 테이블 영역 */
    .table-wrapper {
      overflow-x: auto;
      margin: 0 auto 60px;
      width: 95%;
      animation: fadeIn 0.4s ease-in;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f7f7f7;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    tbody tr:nth-child(odd) { background-color: #fcfcfc; }
    tbody tr:hover { background-color: #eef6ff; }

    /* 데스크톱 이미지 셀 */
    td.image-cell { width: 110px; min-width: 110px; }
    .table-image {
      width: 90px; height: 90px; background: #eee;
      display: flex; align-items: center; justify-content: center;
      border-radius: 8px; overflow: hidden; cursor: pointer; user-select: none;
    }
    .table-image img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .table-image .no-image { color: #aaa; font-size: 12px; }

    /* TOP 버튼 */
    .top-button {
      position: fixed; bottom: 30px; right: 30px; z-index: 99;
      background-color: #333; color: #fff; border: none;
      padding: 10px 14px; border-radius: 6px; font-size: 14px;
    }
    .top-button:hover { background-color: #555; }

    .fab-menu { display: none; }

    /* FAB 메뉴 (모바일 전용) */
    @media (max-width: 600px) {
      .top-button, #viewCartBtn { display: none !important; }

      .fab-menu {
        display: flex; position: fixed; right: 20px; bottom: 90px; z-index: 999;
        flex-direction: column-reverse; align-items: flex-end;
      }
      .fab-main {
        width: 40px; height: 40px; font-size: 22px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%; background-color: #0071e3; color: white; border: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; padding: 0; transition: transform 0.3s ease;
      }
      .fab-actions {
        flex-direction: column; gap: 10px; margin-bottom: 10px;
        opacity: 0; transform: translateY(20px); pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease; display: flex;
      }
      .fab-menu.open .fab-actions { opacity: 1; transform: translateY(0); pointer-events: auto; }
      .fab-action {
        padding: 10px 16px; background-color: #333; color: white;
        border: none; border-radius: 6px; font-size: 14px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15); cursor: pointer; transition: background-color 0.2s ease;
      }
      .fab-action:hover { background-color: #555; }
    }

    /* 모달 */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; padding: 24px; width: 90%; max-width: 600px; max-height: 90vh;
      overflow-y: auto; border-radius: 10px; position: relative; animation: slideUp 0.3s ease forwards;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
    .modal-close { position: absolute; top: 12px; right: 16px; font-size: 24px; cursor: pointer; color: #666; transition: color 0.3s; }
    .modal-close:hover { color: #000; }

    /* 상세 정보 블록 (이미지와 유튜브 사이) */
    .info-block {
      border: 1px solid #eee; background: #fafafa; border-radius: 8px;
      padding: 12px 14px; margin: 12px 0 16px; line-height: 1.6;
    }
    .info-block p { margin: 4px 0; word-break: keep-all; }

    /* 비디오 */
    .video-wrapper { position: relative; padding-top: 56.25%; height: 0; overflow: hidden; margin-bottom: 16px; }
    .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    /* 모바일 카드 뷰 */
    @media (max-width: 600px) {
      table { display: none; }
      .card-list { display: flex; flex-direction: column; gap: 16px; padding: 0 5%; }
      .card-item { display: flex; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
      .card-item .card-image { width: 100px; height: 100px; background-color: #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; }
      .card-item .card-image img { width: 100%; height: 100%; object-fit: cover; }
      .card-content { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
      .card-content div { margin-bottom: 4px; font-size: 14px; }
    }

    /* 페이지네이션 */
    #pagination { text-align: center; margin-bottom: 40px; }
    #pagination button {
      background-color: #f2f2f2; border: 1px solid #ccc; color: #333;
      margin: 0 4px; padding: 6px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #pagination button:hover:not(:disabled) { background-color: #e0e0e0; }
    #pagination button:disabled {
      background-color: #fff; border: 1px solid #ccc; color: #111; font-weight: bold; cursor: default;
    }
    #pagination span { display: inline-block; margin: 0 6px; color: #888; font-size: 14px; }
  </style>
</head>
<body>
  <h1>MOSAIC 재고 검색</h1>

  <div class="search-wrapper">
    <div class="filters">
      <select id="storeFilter">
        <option value="all">매장 전체</option>
        <option value="WEST">WEST</option>
        <option value="EAST">EAST</option>
      </select>
      <select id="genreFilter"><option value="all">장르 전체</option></select>
      <select id="searchScope">
        <option value="all">전체검색</option>
        <option value="Artist">아티스트</option>
        <option value="Title">타이틀</option>
        <option value="Label">레이블</option>
        <option value="Tracklist">트랙리스트</option>
        <option value="Credits">크레딧</option>
      </select>
      <input type="text" id="searchInput" placeholder="검색어 입력" />
      <button id="searchBtn">검색</button>
    </div>
  </div>

  <div id="results"></div>
  <div id="pagination" style="text-align:center; margin-bottom: 40px;"></div>

  <!-- 상세 모달 -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <span id="modalClose" class="modal-close">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- TOP 버튼 (데스크톱 전용) -->
  <button class="top-button" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">TOP</button>

  <script>
  const SHEET_URL = "./data.json";

  /* 감열지 용지 너비(mm) — 58mm/80mm 등으로 쉽게 변경 */
  const PAPER_WIDTH_MM = 58;
  /* 일부 브라우저에서 빈 인쇄 방지용 지연(ms) */
  const PRINT_DELAY_MS = 300;

  /* 데스크톱 테이블 표시 컬럼 */
  const displayOrder = [
    "Image",
    "Artist", "Title", "Label", "Pressing", "Genre", "Style",
    "Subcategory", "Condition Jacket", "Condition Media",
    "Selling at", "Details"
  ];

  const allDisplayNames = {
    "Image": "이미지",
    "Ref": "상품번호", "Artist": "아티스트", "Title": "타이틀",
    "Label": "레이블", "Pressing": "프레싱", "Genre": "장르", "Style": "스타일",
    "Subcategory": "진열 위치", "Condition Jacket": "자켓", "Condition Media": "미디어",
    "Selling at": "가격", "Details": "상세", "Youtube": "YouTube"
  };

  function getMainImageUrl(urlField) {
    if (!urlField) return "";
    const parts = String(urlField).split("•").map(s => s.trim()).filter(Boolean);
    return parts[0] || "";
  }

  let allData = [];
  let currentPage = 1;
  const itemsPerPage = 30;

  const results = document.getElementById("results");
  results.innerHTML = `<div style="text-align:center; margin:40px 0; color:#555; font-size:16px;">데이터 불러오는 중입니다...</div>`;
  document.getElementById("searchBtn").disabled = true;

  /* 동적 프린트 스타일(@page size)을 주입 */
  function ensurePrintCSS() {
    const styleId = 'dynamicPrintStyle';
    let styleEl = document.getElementById(styleId);
    if (!styleEl) {
      styleEl = document.createElement('style');
      styleEl.id = styleId;
      document.head.appendChild(styleEl);
    }
    styleEl.textContent = `
      @page { size: ${PAPER_WIDTH_MM}mm auto; margin: 0; }
      @media print {
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body * { visibility: hidden; }
        #printArea, #printArea * { visibility: visible; }
        #printArea {
          position: fixed; left: 0; top: 0;
          width: ${PAPER_WIDTH_MM}mm; padding: 4mm;
          background: #fff; color: #000; font-size: 12px; line-height: 1.45;
        }
        #printArea .r-title { font-weight: 700; font-size: 14px; text-align: center; margin-bottom: 2mm; }
        #printArea .r-meta { text-align: center; font-size: 11px; margin-bottom: 3mm; }
        #printArea .cut { border-top: 1px dashed #000; margin: 2mm 0; }
        #printArea .item { margin: 2mm 0; }
        #printArea .line1 { font-weight: 700; }
        #printArea .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        #printArea .price { font-weight: 700; }
        #printArea .foot { margin-top: 3mm; text-align:center; font-size: 11px; }
      }
    `;
  }

  fetch(SHEET_URL)
    .then(res => res.json())
    .then(data => {
      allData = data;
      populateGenreFilter(data);
      filterAndRenderTable();
    })
    .catch(err => {
      results.innerHTML = `<div style="text-align:center; margin:40px 0; color:#c00;">데이터를 불러오지 못했습니다.</div>`;
      console.error("데이터 로드 오류:", err);
    })
    .finally(() => {
      document.getElementById("searchBtn").disabled = false;
      ensurePrintCSS();
    });

  function populateGenreFilter(data) {
    const genreSelect = document.getElementById("genreFilter");
    const genreSet = new Set();
    data.forEach(item => {
      const genre = item["Genre"];
      if (genre) genreSet.add(genre.trim());
    });
    genreSelect.innerHTML = `<option value="all">장르 전체</option>`;
    [...genreSet].sort().forEach(genre => {
      const option = document.createElement("option");
      option.value = genre;
      option.textContent = genre;
      genreSelect.appendChild(option);
    });
  }

  function filterAndRenderTable() {
    const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
    const scope = document.getElementById("searchScope").value;
    const selectedStore = document.getElementById("storeFilter").value;
    const selectedGenre = document.getElementById("genreFilter").value;

    const filtered = allData.filter(item => {
      const store = String(item.OriginSheet ?? "").trim();
      const genre = String(item["Genre"] ?? "").trim();
      if (selectedStore !== "all" && store !== selectedStore) return false;
      if (selectedGenre !== "all" && genre !== selectedGenre) return false;

      const artist = String(item["Artist"] ?? "").toLowerCase();
      const title = String(item["Title"] ?? "").toLowerCase();
      const label = String(item["Label"] ?? "").toLowerCase();
      const tracklist = String(item["Tracklist"] ?? "").toLowerCase();
      const credits = String(item["Credits"] ?? "").toLowerCase();

      switch (scope) {
        case "Artist": return artist.includes(keyword);
        case "Title": return title.includes(keyword);
        case "Label": return label.includes(keyword);
        case "Tracklist": return tracklist.includes(keyword);
        case "Credits": return credits.includes(keyword);
        default:
          return artist.includes(keyword) || title.includes(keyword) || label.includes(keyword) || tracklist.includes(keyword) || credits.includes(keyword);
      }
    });

    currentPage = 1;
    renderTable(filtered);
  }

  function renderTable(data) {
    const results = document.getElementById("results");
    const pagination = document.getElementById("pagination");

    if (data.length === 0) {
      results.innerHTML = `<div style="text-align:center; margin:40px 0; font-size:16px; color:#777;">검색 결과가 없습니다.</div>`;
      pagination.innerHTML = "";
      return;
    }

    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageData = data.slice(start, end);
    window.currentData = data;

    let html = "";

    if (window.innerWidth <= 600) {
      /* 모바일 카드 뷰 */
      html = `<div class="card-list">`;
      pageData.forEach((item, idx) => {
        const imageURL = getMainImageUrl(item["Image URL"]);
        const imageBlock = imageURL
          ? `<div class="card-image" onclick="showDetails(${start + idx})"><img src="${imageURL}" alt="앨범 이미지" loading="lazy"></div>`
          : `<div class="card-image" onclick="showDetails(${start + idx})"><span style="color:#aaa;font-size:12px;">NO IMAGE</span></div>`;
        html += `
          <div class="card-item">
            ${imageBlock}
            <div class="card-content">
              <div><strong>${item.Artist || ""}</strong> - ${item.Title || ""}</div>
              <div>${item.Pressing || ""}</div>
              <div>${item["Condition Jacket"] || ""} / ${item["Condition Media"] || ""}</div>
              <div><strong>₩${Number(item["Selling at"] || 0).toLocaleString()}</strong></div>
            </div>
          </div>`;
      });
      html += `</div>`;
    } else {
      /* 데스크톱 테이블 뷰 */
      html = `<div class="table-wrapper"><table><thead><tr>`;
      displayOrder.forEach(key => { html += `<th>${allDisplayNames[key] || key}</th>`; });
      html += `</tr></thead><tbody>`;

      pageData.forEach((row, idx) => {
        html += `<tr>`;
        displayOrder.forEach(key => {
          if (key === "Image") {
            const imageURL = getMainImageUrl(row["Image URL"]);
            const imgHtml = imageURL
              ? `<div class="table-image" onclick="showDetails(${start + idx})"><img src="${imageURL}" alt="이미지" loading="lazy"></div>`
              : `<div class="table-image" onclick="showDetails(${start + idx})"><span class="no-image">NO IMAGE</span></div>`;
            html += `<td class="image-cell">${imgHtml}</td>`;
            return;
          }
          let cell = row[key] ?? "";
          if (key === "Selling at" && !isNaN(cell)) cell = Number(cell).toLocaleString();
          if (key === "Details") cell = `<button onclick="showDetails(${start + idx})">상세</button>`;
          html += `<td>${cell}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table></div>`;
    }

    results.innerHTML = html;
    renderPagination(data.length);
  }

  /* 상세 모달 */
  window.showDetails = function(index) {
    const item = window.currentData[index];
    const modal = document.getElementById("detailModal");
    const body = document.getElementById("modalBody");

    const title = `${item["Artist"] || ""} - ${item["Title"] || ""}`;
    const ref = item["Ref"] || "";

    let content = `<h4 style="margin-top: 0;">${title}</h4><p style="margin-top: -8px;">${ref}</p>`;

    /* 이미지 */
    const mainImg = getMainImageUrl(item["Image URL"]);
    if (mainImg) {
      content += `<p><strong>이미지:</strong><br><img src="${mainImg}" alt="이미지" style="max-width: 100%; margin: 10px 0;" loading="lazy"></p>`;
    }

    /* 정보 블록 */
    const store   = item.OriginSheet || "";
    const pressing = item.Pressing || "";
    const jacket  = item["Condition Jacket"] || "";
    const media   = item["Condition Media"] || "";
    const comment = item["Condition Comment"] || "";
    const priceN  = Number(item["Selling at"] || 0);
    const price   = isNaN(priceN) ? "" : priceN.toLocaleString();

    let info = `<div class="info-block">`;
    if (store)   info += `<p><strong>Store :</strong> ${store}</p>`;
    if (pressing)info += `<p><strong>Pressing :</strong> ${pressing}</p>`;
    if (jacket || media) info += `<p><strong>Jacket:</strong> ${jacket || "-"} <strong>/ Media:</strong> ${media || "-"}</p>`;
    if (comment) info += `<p>●${comment}</p>`;
    if (price)   info += `<p><strong>Price :</strong> ${price}</p>`;
    info += `</div>`;
    content += info;

    /* YouTube */
    if (item.Youtube?.trim()) {
      const url = item.Youtube.trim();
      let embedUrl = "";
      if (url.includes("youtube.com/watch?v=")) {
        embedUrl = `https://www.youtube.com/embed/${url.split("v=")[1].split("&")[0]}`;
      } else if (url.includes("youtu.be/")) {
        embedUrl = `https://www.youtube.com/embed/${url.split("youtu.be/")[1].split("?")[0]}`;
      }
      if (embedUrl) {
        content += `<p><strong>YouTube:</strong><br><div class="video-wrapper"><iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe></div></p>`;
      }
    }

    /* Tracklist */
    if (item.Tracklist?.trim()) {
      const list = item.Tracklist.split("•").map(s => s.trim()).filter(Boolean);
      if (list.length) {
        content += `<p><strong>Tracklist:</strong><ul>${list.map(track => `<li>${track}</li>`).join('')}</ul></p>`;
      }
    }

    /* Credits */
    if (item.Credits?.trim()) {
      const credits = item.Credits.split("•").map(s => s.trim()).filter(Boolean);
      if (credits.length) {
        content += `<p><strong>Credits:</strong><br>${credits.join("<br>")}</p>`;
      }
    }

    content += `<div style="text-align: right; margin-top: 20px;">
      <button onclick="addToCart(${index})" style="background-color: #0071e3; color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 14px;">🛒 장바구니 담기</button>
    </div>`;

    body.innerHTML = content;
    modal.style.display = "flex";
  };

  document.getElementById("modalClose").onclick = () => {
    document.getElementById("detailModal").style.display = "none";
  };
  window.onclick = e => {
    if (e.target === document.getElementById("detailModal"))
      document.getElementById("detailModal").style.display = "none";
  };

  document.getElementById("searchInput").addEventListener("keydown", e => {
    if (e.key === "Enter") { e.target.blur(); filterAndRenderTable(); }
  });
  document.getElementById("searchBtn").addEventListener("click", () => {
    document.getElementById("searchInput").blur(); filterAndRenderTable();
  });
  document.getElementById("storeFilter").addEventListener("change", filterAndRenderTable);
  document.getElementById("genreFilter").addEventListener("change", filterAndRenderTable);
  document.getElementById("searchScope").addEventListener("change", filterAndRenderTable);

  document.addEventListener("keydown", e => {
    if (e.key === "Escape") {
      document.getElementById("detailModal").style.display = "none";
    }
  });

  function debounce(func, delay = 300) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  window.addEventListener("resize", debounce(() => {
    if (window.currentData?.length > 0) { renderTable(window.currentData); }
    else { filterAndRenderTable(); }
  }, 300));

  function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const pagination = document.getElementById("pagination");
    let html = "";

    if (totalPages <= 1) { pagination.innerHTML = ""; return; }

    html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>« 이전</button>`;
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
        html += `<button onclick="goToPage(${i})" ${i === currentPage ? 'disabled' : ''}>${i}</button>`;
      } else if ((i === 2 && currentPage - 3 > 1) || (i === totalPages - 1 && currentPage + 3 < totalPages)) {
        html += `<span style="margin:0 4px;">...</span>`;
      }
    }
    html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>다음 »</button>`;
    pagination.innerHTML = html;
  }

  function goToPage(page) {
    currentPage = page;
    renderTable(window.currentData);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  /* 장바구니 로직 */
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("viewCartBtn").onclick = renderCartModal;

    document.getElementById("cartModalClose").onclick = () => {
      document.getElementById("cartModal").style.display = "none";
    };
    window.addEventListener("click", e => {
      if (e.target === document.getElementById("cartModal")) {
        document.getElementById("cartModal").style.display = "none";
      }
    });
  });

  function renderCartModal() {
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const cartBody = document.getElementById("cartBody");

    if (cart.length === 0) {
      cartBody.innerHTML = `<p>장바구니가 비어 있습니다.</p>`;
    } else {
      let total = 0;
      const itemsHtml = cart.map((item, idx) => {
        total += Number(item.price || 0);
        return `<div style="margin-bottom: 12px;">
  <input type="checkbox" class="cart-item-checkbox" data-index="${idx}" style="margin-right: 6px;">
  <strong>${idx + 1}. [${item.ref}] ${item.artist} – ${item.title}</strong><br>
  <span style="font-size: 14px;">
    ${item.jacket} / ${item.media} / ${item.pressing}<br>
    진열 위치: ${item.subcategory || "-"}<br>
    매장: ${item.store}<br>
    가격: ₩${Number(item.price || 0).toLocaleString()}
  </span>
</div>`;
      }).join('');

      /* ✅ 인쇄 버튼을 왼쪽(카카오 왼쪽)으로 이동 */
      cartBody.innerHTML = `
${itemsHtml}
<hr>
<p><strong>총 ${cart.length}개 (합계: ₩${total.toLocaleString()})</strong></p>
<div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-top:16px;">
  <div>
    <button onclick="printCart()" style="background:#0071e3; margin-right:10px;">🖨 인쇄하기</button>
    <button onclick="window.open('https://pf.kakao.com/_xxx/chat', '_blank')">💬 카카오톡 문의</button>
  </div>
  <div>
    <button id="deleteSelectedBtn" onclick="deleteSelectedCartItems()" style="background:#ccc; color:#000; margin-right: 10px;" disabled>🗑 선택 항목 삭제</button>
    <button onclick="clearCart()" style="background:#ccc; color:#000;">❌ 전체 비우기</button>
  </div>
</div>
`;
      monitorCartCheckboxes();
    }

    document.getElementById("cartModal").style.display = "flex";
  }

  function clearCart() {
    if (confirm("장바구니를 모두 비우시겠습니까?")) {
      localStorage.removeItem("cart");
      document.getElementById("cartModal").style.display = "none";
      alert("장바구니가 비워졌습니다.");
    }
  }

  function addToCart(index) {
    const item = window.currentData[index];
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");

    const exists = cart.some(c => c.ref === item.Ref);
    if (exists) { alert("이미 장바구니에 담긴 상품입니다."); return; }

    const price = Number(item["Selling at"] || 0);
    const newItem = {
      ref: item.Ref || "",
      artist: item.Artist || "",
      title: item.Title || "",
      jacket: item["Condition Jacket"] || "",
      media: item["Condition Media"] || "",
      pressing: item.Pressing || "",
      subcategory: item.Subcategory || item["Subcategory"] || "",
      price: price,
      store: item.OriginSheet || ""
    };

    cart.push(newItem);
    localStorage.setItem("cart", JSON.stringify(cart));
    alert("장바구니에 추가되었습니다.");
  }

  function deleteSelectedCartItems() {
    const checkboxes = document.querySelectorAll(".cart-item-checkbox:checked");
    if (checkboxes.length === 0) { alert("삭제할 항목을 선택해주세요."); return; }
    if (!confirm("선택한 항목을 장바구니에서 삭제할까요?")) return;

    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const updatedCart = cart.filter((_, idx) => {
      return !Array.from(checkboxes).some(cb => Number(cb.dataset.index) === idx);
    });

    localStorage.setItem("cart", JSON.stringify(updatedCart));
    alert("선택한 항목이 삭제되었습니다.");
    renderCartModal(); // 다시 로드
  }

  function monitorCartCheckboxes() {
    const checkboxes = document.querySelectorAll(".cart-item-checkbox");
    const deleteBtn = document.getElementById("deleteSelectedBtn");
    if (!deleteBtn) return;

    const updateDeleteButtonState = () => {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      deleteBtn.disabled = !anyChecked;
    };
    checkboxes.forEach(cb => { cb.addEventListener("change", updateDeleteButtonState); });
    updateDeleteButtonState();
  }

  /* 인쇄용 HTML 생성 & 출력 */
  function printCart() {
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    if (cart.length === 0) { alert("장바구니가 비어 있습니다."); return; }

    ensurePrintCSS();

    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const hh = String(now.getHours()).padStart(2, '0');
    const mi = String(now.getMinutes()).padStart(2, '0');

    const header = `
      <div class="r-title">MOSAIC PICK LIST</div>
      <div class="r-meta mono">${yyyy}-${mm}-${dd} ${hh}:${mi} | 총 ${cart.length}개</div>
      <div class="cut"></div>
    `;

    const items = cart.map((it, i) => {
      const priceStr = Number(it.price || 0).toLocaleString();
      return `
        <div class="item">
          <div class="line1">#${i+1} [${it.ref}] ${it.artist} – ${it.title}</div>
          ${it.pressing ? `<div>Pressing : ${it.pressing}</div>` : ``}
          <div>Jacket : ${it.jacket || '-'} / Media : ${it.media || '-'}</div>
          <div>Subcategory : ${it.subcategory || '-'}</div>
          <div class="price">Price : ₩${priceStr}</div>
        </div>
        <div class="cut"></div>
      `;
    }).join('');

    const footer = `<div class="foot mono">※ 매장 진열 위치를 기준으로 상품을 찾아주세요.</div>`;

    const printArea = document.getElementById('printArea');
    printArea.innerHTML = header + items + footer;

    /* ✅ 짧은 지연 후 인쇄(빈 인쇄 방지) */
    setTimeout(() => {
      window.print();
    }, PRINT_DELAY_MS);
  }
  </script>

  <!-- 🛒 장바구니 보기 버튼 (데스크톱 전용) -->
  <button id="viewCartBtn" style="
    position: fixed;
    bottom: 80px;
    right: 30px;
    z-index: 100;
    padding: 10px 16px;
    font-size: 14px;
    background-color: #0071e3;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  ">🛒 장바구니</button>

  <!-- 장바구니 모달 -->
  <div id="cartModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <span id="cartModalClose" class="modal-close">&times;</span>
      <div id="cartBody"></div>
    </div>
  </div>

  <!-- FAB 메뉴 (모바일 전용) -->
  <div class="fab-menu">
    <button class="fab-main" onclick="document.querySelector('.fab-menu').classList.toggle('open')" aria-label="FAB 메뉴 열기">＋</button>
    <div class="fab-actions">
      <button class="fab-action" onclick="window.scrollTo({ top: 0, behavior: 'smooth' }); document.querySelector('.fab-menu').classList.remove('open')">TOP</button>
      <button class="fab-action" onclick="document.getElementById('viewCartBtn').click(); document.querySelector('.fab-menu').classList.remove('open')">🛒 장바구니</button>
    </div>
  </div>

  <!-- 🔒 인쇄 전용 영역(화면에 표시되지 않음) -->
  <div id="printArea" style="display:block; position:absolute; left:-9999px; top:-9999px;"></div>
</body>
</html>
