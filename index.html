<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WEST 재고 검색</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fafafa;
    }

    h1 {
      text-align: center;
      margin: 30px 0 20px;
      font-size: 28px;
    }

    .search-container {
      text-align: center;
      margin-bottom: 10px;
    }

    .search-container input,
    .search-container select,
    .search-container button {
      font-size: 16px;
    }

    .search-container select {
      padding: 10px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .search-container input {
      padding: 10px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 320px;
      max-width: 90%;
    }

    .search-container button {
      padding: 10px 18px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .search-container button:hover {
      background-color: #555;
    }

    .table-wrapper {
      overflow-x: auto;
      margin: 0 auto;
      width: 95%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background-color: #fff;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      vertical-align: top;
    }

    th {
      background-color: #f7f7f7;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tbody tr:nth-child(odd) {
      background-color: #fcfcfc;
    }

    tbody tr:hover {
      background-color: #eef6ff;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 10px;
      padding: 10px 20px;
      background-color: #f7f7f7;
      border-top: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
      margin-bottom: 10px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }

    .filter-group label {
      margin-bottom: 2px;
      font-weight: 500;
    }

    select.filter-select {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      min-width: 140px;
    }

    .top-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 99;
      background-color: #333;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .top-button:hover {
      background-color: #555;
    }

    @media screen and (max-width: 600px) {
      h1 {
        font-size: 22px;
      }

      .search-container input,
      .search-container select,
      .search-container button {
        width: 90%;
        font-size: 14px;
      }

      table {
        font-size: 12px;
      }

      .filter-bar {
        flex-direction: column;
      }

      .filter-select {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <h1>MOSAIC WEST 재고 검색</h1>

  <div class="search-container">
    <select id="searchScope">
      <option value="all">전체검색</option>
      <option value="Artist">아티스트</option>
      <option value="Title">타이틀</option>
      <option value="Label">레이블</option>
      <option value="Credits">크레딧</option>
      <option value="Tracklist">수록곡</option>
    </select>
    <input type="text" id="searchInput" placeholder="검색어 입력" />
    <button id="searchBtn">검색</button>
  </div>

  <div id="filterBar" class="filter-bar"></div>
  <div id="results" class="loading">데이터 불러오는 중...</div>

  <button onclick="scrollToTop()" class="top-button">TOP</button>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const SHEET_URL = "./data.json";

      const displayOrder = [
        "Ref", "Artist", "Title", "Label", "Pressing", "Genre", "Style", "Subcategory",
        "Condition Jacket", "Condition Media", "Condition Comment",
        "Selling at", "QR code"
      ];

      const headerDisplayNames = {
        "Genre": "장르",
        "Condition Jacket": "자켓",
        "Condition Media": "미디어",
        "Selling at": "가격 정렬"
      };

      const allDisplayNames = {
        "Ref": "상품번호",
        "Artist": "아티스트",
        "Title": "타이틀",
        "Label": "레이블",
        "Pressing": "프레싱",
        "Genre": "장르",
        "Style": "스타일",
        "Subcategory": "진열 위치",
        "Condition Jacket": "자켓",
        "Condition Media": "미디어",
        "Condition Comment": "상태",
        "Selling at": "가격",
        "QR code": "Youtube"
      };

      let allData = [];
      const filters = {
        genre: "",
        jacket: "",
        media: "",
        priceSort: ""
      };

      fetch(SHEET_URL)
        .then(res => res.json())
        .then(data => {
          allData = data;
          renderFilterBar();
          filterAndRenderTable();
        })
        .catch(err => {
          document.getElementById("results").innerHTML = `<p class="loading">에러 발생: ${err.message}</p>`;
        });

      function getUniqueValues(field) {
        const values = new Set();
        allData.forEach(item => {
          if (item[field]) values.add(item[field]);
        });
        return Array.from(values).sort();
      }

      function renderFilterBar() {
        const filterBar = document.getElementById("filterBar");
        filterBar.innerHTML = "";

        const filtersToRender = [
          { id: "genre", label: "Genre", placeholder: "전체 장르" },
          { id: "jacket", label: "Condition Jacket", placeholder: "전체 자켓" },
          { id: "media", label: "Condition Media", placeholder: "전체 미디어" },
          { id: "priceSort", label: "Selling at", placeholder: "가격 정렬", options: ["asc", "desc"] }
        ];

        filtersToRender.forEach(({ id, label, placeholder, options }) => {
          const group = document.createElement("div");
          group.className = "filter-group";

          const labelEl = document.createElement("label");
          labelEl.textContent = headerDisplayNames[label] || label;
          group.appendChild(labelEl);

          const select = document.createElement("select");
          select.id = id + "Filter";
          select.className = "filter-select";

          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = placeholder;
          select.appendChild(defaultOption);

          const values = options || getUniqueValues(label);
          values.forEach(value => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = value;
            if (filters[id] === value) option.selected = true;
            select.appendChild(option);
          });

          select.addEventListener("change", e => {
            filters[id] = e.target.value;
            filterAndRenderTable();
          });

          group.appendChild(select);
          filterBar.appendChild(group);
        });
      }

      function filterAndRenderTable() {
        const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
        const scope = document.getElementById("searchScope").value;

        let filtered = allData.filter(item => {
          const artist = (item["Artist"] ?? "").toLowerCase();
          const title = (item["Title"] ?? "").toLowerCase();
          const label = (item["Label"] ?? "").toLowerCase();
          const tracklist = (item["Tracklist"] ?? "").toLowerCase();
          const credits = (item["Credits"] ?? "").toLowerCase();

          let matchKeyword = false;
          switch (scope) {
            case "Artist":
              matchKeyword = artist.includes(keyword);
              break;
            case "Title":
              matchKeyword = title.includes(keyword);
              break;
            case "Label":
              matchKeyword = label.includes(keyword);
              break;
            case "Tracklist":
              matchKeyword = tracklist.includes(keyword);
              break;
            case "Credits":
              matchKeyword = credits.includes(keyword);
              break;
            case "all":
            default:
              matchKeyword =
                artist.includes(keyword) ||
                title.includes(keyword) ||
                label.includes(keyword) ||
                tracklist.includes(keyword) ||
                credits.includes(keyword);
          }

          const matchGenre = !filters.genre || item["Genre"] === filters.genre;
          const matchJacket = !filters.jacket || item["Condition Jacket"] === filters.jacket;
          const matchMedia = !filters.media || item["Condition Media"] === filters.media;

          return matchKeyword && matchGenre && matchJacket && matchMedia;
        });

        if (filters.priceSort === "asc") {
          filtered.sort((a, b) => (a["Selling at"] || 0) - (b["Selling at"] || 0));
        } else if (filters.priceSort === "desc") {
          filtered.sort((a, b) => (b["Selling at"] || 0) - (a["Selling at"] || 0));
        }

        renderTable(filtered);
      }

      function renderTable(data) {
        const results = document.getElementById("results");

        if (!data.length) {
          results.innerHTML = "<p class='loading'>표시할 데이터가 없습니다.</p>";
          return;
        }

        let html = `<div class="table-wrapper"><table><thead><tr>`;
        displayOrder.forEach(key => {
          html += `<th>${allDisplayNames[key] || key}</th>`;
        });
        html += `</tr></thead><tbody>`;

        data.forEach(row => {
          html += `<tr>`;
          displayOrder.forEach(key => {
            let cell = row[key] ?? "";
            if (key === "QR code" && cell) {
              cell = `<a href="${cell}" target="_blank" rel="noopener noreferrer">링크</a>`;
            }
            if (key === "Selling at" && !isNaN(cell)) {
              cell = Number(cell).toLocaleString();
            }
            html += `<td>${cell}</td>`;
          });
          html += `</tr>`;
        });

        html += `</tbody></table></div>`;
        results.innerHTML = html;
      }

      document.getElementById("searchInput").addEventListener("keydown", e => {
        if (e.key === "Enter") {
          filterAndRenderTable();
        }
      });

      document.getElementById("searchBtn").addEventListener("click", () => {
        filterAndRenderTable();
      });

      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });
  </script>
</body>
</html>
