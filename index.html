<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MOSAIC ì¬ê³  ê²€ìƒ‰</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ê³µí†µ ìŠ¤íƒ€ì¼ */
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fafafa;
      color: #1f1f1f;
    }
    h1 {
      text-align: center;
      margin: 30px 0 10px;
      font-size: 28px;
      font-weight: 600;
    }
    select, input[type="text"], button {
      font-size: 16px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    input[type="text"]:focus, select:focus {
      border-color: #0071e3;
      box-shadow: 0 0 0 3px rgba(0,113,227,0.2);
    }
    button {
      background-color: #333;
      color: #fff;
      cursor: pointer;
    }
    button:hover { background-color: #555; }
    button:disabled {
      background-color: #ccc;
      color: #666;
      cursor: default;
    }

    /* ê²€ìƒ‰ ë° í•„í„° ì˜ì—­ */
    .search-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 0 5% 30px;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* í…Œì´ë¸” ì˜ì—­ */
    .table-wrapper {
      overflow-x: auto;
      margin: 0 auto 60px;
      width: 95%;
      animation: fadeIn 0.4s ease-in;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f7f7f7;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    tbody tr:nth-child(odd) { background-color: #fcfcfc; }
    tbody tr:hover { background-color: #eef6ff; }

    /* ë°ìŠ¤í¬í†± ì´ë¯¸ì§€ ì…€ */
    td.image-cell { width: 110px; min-width: 110px; }
    .table-image {
      width: 90px; height: 90px; background: #eee;
      display: flex; align-items: center; justify-content: center;
      border-radius: 8px; overflow: hidden; cursor: pointer; user-select: none;
    }
    .table-image img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .table-image .no-image { color: #aaa; font-size: 12px; }

    /* TOP ë²„íŠ¼ */
    .top-button {
      position: fixed; bottom: 30px; right: 30px; z-index: 99;
      background-color: #333; color: #fff; border: none;
      padding: 10px 14px; border-radius: 6px; font-size: 14px;
    }
    .top-button:hover { background-color: #555; }

    .fab-menu { display: none; }

    /* FAB ë©”ë‰´ (ëª¨ë°”ì¼ ì „ìš©) */
    @media (max-width: 600px) {
      .top-button, #viewCartBtn { display: none !important; }

      .fab-menu {
        display: flex; position: fixed; right: 20px; bottom: 90px; z-index: 999;
        flex-direction: column-reverse; align-items: flex-end;
      }
      .fab-main {
        width: 40px; height: 40px; font-size: 22px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%; background-color: #0071e3; color: white; border: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; padding: 0; transition: transform 0.3s ease;
      }
      .fab-actions {
        flex-direction: column; gap: 10px; margin-bottom: 10px;
        opacity: 0; transform: translateY(20px); pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease; display: flex;
      }
      .fab-menu.open .fab-actions { opacity: 1; transform: translateY(0); pointer-events: auto; }
      .fab-action {
        padding: 10px 16px; background-color: #333; color: white;
        border: none; border-radius: 6px; font-size: 14px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15); cursor: pointer; transition: background-color 0.2s ease;
      }
      .fab-action:hover { background-color: #555; }
    }

    /* ëª¨ë‹¬ */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; padding: 24px; width: 90%; max-width: 600px; max-height: 90vh;
      overflow-y: auto; border-radius: 10px; position: relative; animation: slideUp 0.3s ease forwards;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
    .modal-close { position: absolute; top: 12px; right: 16px; font-size: 24px; cursor: pointer; color: #666; transition: color 0.3s; }
    .modal-close:hover { color: #000; }

    /* ìƒì„¸ ì •ë³´ ë¸”ë¡ (ì´ë¯¸ì§€ì™€ ìœ íŠœë¸Œ ì‚¬ì´) */
    .info-block {
      border: 1px solid #eee; background: #fafafa; border-radius: 8px;
      padding: 12px 14px; margin: 12px 0 16px; line-height: 1.6;
    }
    .info-block p { margin: 4px 0; word-break: keep-all; }

    /* ë¹„ë””ì˜¤ */
    .video-wrapper { position: relative; padding-top: 56.25%; height: 0; overflow: hidden; margin-bottom: 16px; }
    .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    /* ëª¨ë°”ì¼ ì¹´ë“œ ë·° */
    @media (max-width: 600px) {
      table { display: none; }
      .card-list { display: flex; flex-direction: column; gap: 16px; padding: 0 5%; }
      .card-item { display: flex; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
      .card-item .card-image { width: 100px; height: 100px; background-color: #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; }
      .card-item .card-image img { width: 100%; height: 100%; object-fit: cover; }
      .card-content { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
      .card-content div { margin-bottom: 4px; font-size: 14px; }
    }

    /* í˜ì´ì§€ë„¤ì´ì…˜ */
    #pagination { text-align: center; margin-bottom: 40px; }
    #pagination button {
      background-color: #f2f2f2; border: 1px solid #ccc; color: #333;
      margin: 0 4px; padding: 6px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #pagination button:hover:not(:disabled) { background-color: #e0e0e0; }
    #pagination button:disabled {
      background-color: #fff; border: 1px solid #ccc; color: #111; font-weight: bold; cursor: default;
    }
    #pagination span { display: inline-block; margin: 0 6px; color: #888; font-size: 14px; }
  </style>
</head>
<body>
  <h1>MOSAIC ì¬ê³  ê²€ìƒ‰</h1>

  <div class="search-wrapper">
    <div class="filters">
      <select id="storeFilter">
        <option value="all">ë§¤ì¥ ì „ì²´</option>
        <option value="WEST">WEST</option>
        <option value="EAST">EAST</option>
      </select>
      <select id="genreFilter"><option value="all">ì¥ë¥´ ì „ì²´</option></select>
      <select id="searchScope">
        <option value="all">ì „ì²´ê²€ìƒ‰</option>
        <option value="Artist">ì•„í‹°ìŠ¤íŠ¸</option>
        <option value="Title">íƒ€ì´í‹€</option>
        <option value="Label">ë ˆì´ë¸”</option>
        <option value="Tracklist">íŠ¸ë™ë¦¬ìŠ¤íŠ¸</option>
        <option value="Credits">í¬ë ˆë”§</option>
      </select>
      <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
      <button id="searchBtn">ê²€ìƒ‰</button>
    </div>
  </div>

  <div id="results"></div>
  <div id="pagination" style="text-align:center; margin-bottom: 40px;"></div>

  <!-- ìƒì„¸ ëª¨ë‹¬ -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <span id="modalClose" class="modal-close">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- TOP ë²„íŠ¼ (ë°ìŠ¤í¬í†± ì „ìš©) -->
  <button class="top-button" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">TOP</button>

  <script>
  const SHEET_URL = "./data.json";

  /* ê°ì—´ì§€ ìš©ì§€ ë„ˆë¹„(mm) â€” 58mm/80mm ë“±ìœ¼ë¡œ ì‰½ê²Œ ë³€ê²½ */
  const PAPER_WIDTH_MM = 58;
  /* ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ë¹ˆ ì¸ì‡„ ë°©ì§€ìš© ì§€ì—°(ms) */
  const PRINT_DELAY_MS = 300;

  /* ë°ìŠ¤í¬í†± í…Œì´ë¸” í‘œì‹œ ì»¬ëŸ¼ */
  const displayOrder = [
    "Image",
    "Artist", "Title", "Label", "Pressing", "Genre", "Style",
    "Subcategory", "Condition Jacket", "Condition Media",
    "Selling at", "Details"
  ];

  const allDisplayNames = {
    "Image": "ì´ë¯¸ì§€",
    "Ref": "ìƒí’ˆë²ˆí˜¸", "Artist": "ì•„í‹°ìŠ¤íŠ¸", "Title": "íƒ€ì´í‹€",
    "Label": "ë ˆì´ë¸”", "Pressing": "í”„ë ˆì‹±", "Genre": "ì¥ë¥´", "Style": "ìŠ¤íƒ€ì¼",
    "Subcategory": "ì§„ì—´ ìœ„ì¹˜", "Condition Jacket": "ìì¼“", "Condition Media": "ë¯¸ë””ì–´",
    "Selling at": "ê°€ê²©", "Details": "ìƒì„¸", "Youtube": "YouTube"
  };

  function getMainImageUrl(urlField) {
    if (!urlField) return "";
    const parts = String(urlField).split("â€¢").map(s => s.trim()).filter(Boolean);
    return parts[0] || "";
  }

  let allData = [];
  let currentPage = 1;
  const itemsPerPage = 30;

  const results = document.getElementById("results");
  results.innerHTML = `<div style="text-align:center; margin:40px 0; color:#555; font-size:16px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>`;
  document.getElementById("searchBtn").disabled = true;

  /* ë™ì  í”„ë¦°íŠ¸ ìŠ¤íƒ€ì¼(@page size)ì„ ì£¼ì… */
  function ensurePrintCSS() {
    const styleId = 'dynamicPrintStyle';
    let styleEl = document.getElementById(styleId);
    if (!styleEl) {
      styleEl = document.createElement('style');
      styleEl.id = styleId;
      document.head.appendChild(styleEl);
    }
    styleEl.textContent = `
      @page { size: ${PAPER_WIDTH_MM}mm auto; margin: 0; }
      @media print {
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body * { visibility: hidden; }
        #printArea, #printArea * { visibility: visible; }
        #printArea {
          position: fixed; left: 0; top: 0;
          width: ${PAPER_WIDTH_MM}mm; padding: 4mm;
          background: #fff; color: #000; font-size: 12px; line-height: 1.45;
        }
        #printArea .r-title { font-weight: 700; font-size: 14px; text-align: center; margin-bottom: 2mm; }
        #printArea .r-meta { text-align: center; font-size: 11px; margin-bottom: 3mm; }
        #printArea .cut { border-top: 1px dashed #000; margin: 2mm 0; }
        #printArea .item { margin: 2mm 0; }
        #printArea .line1 { font-weight: 700; }
        #printArea .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        #printArea .price { font-weight: 700; }
        #printArea .foot { margin-top: 3mm; text-align:center; font-size: 11px; }
      }
    `;
  }

  fetch(SHEET_URL)
    .then(res => res.json())
    .then(data => {
      allData = data;
      populateGenreFilter(data);
      filterAndRenderTable();
    })
    .catch(err => {
      results.innerHTML = `<div style="text-align:center; margin:40px 0; color:#c00;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
      console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", err);
    })
    .finally(() => {
      document.getElementById("searchBtn").disabled = false;
      ensurePrintCSS();
    });

  function populateGenreFilter(data) {
    const genreSelect = document.getElementById("genreFilter");
    const genreSet = new Set();
    data.forEach(item => {
      const genre = item["Genre"];
      if (genre) genreSet.add(genre.trim());
    });
    genreSelect.innerHTML = `<option value="all">ì¥ë¥´ ì „ì²´</option>`;
    [...genreSet].sort().forEach(genre => {
      const option = document.createElement("option");
      option.value = genre;
      option.textContent = genre;
      genreSelect.appendChild(option);
    });
  }

  function filterAndRenderTable() {
    const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
    const scope = document.getElementById("searchScope").value;
    const selectedStore = document.getElementById("storeFilter").value;
    const selectedGenre = document.getElementById("genreFilter").value;

    const filtered = allData.filter(item => {
      const store = String(item.OriginSheet ?? "").trim();
      const genre = String(item["Genre"] ?? "").trim();
      if (selectedStore !== "all" && store !== selectedStore) return false;
      if (selectedGenre !== "all" && genre !== selectedGenre) return false;

      const artist = String(item["Artist"] ?? "").toLowerCase();
      const title = String(item["Title"] ?? "").toLowerCase();
      const label = String(item["Label"] ?? "").toLowerCase();
      const tracklist = String(item["Tracklist"] ?? "").toLowerCase();
      const credits = String(item["Credits"] ?? "").toLowerCase();

      switch (scope) {
        case "Artist": return artist.includes(keyword);
        case "Title": return title.includes(keyword);
        case "Label": return label.includes(keyword);
        case "Tracklist": return tracklist.includes(keyword);
        case "Credits": return credits.includes(keyword);
        default:
          return artist.includes(keyword) || title.includes(keyword) || label.includes(keyword) || tracklist.includes(keyword) || credits.includes(keyword);
      }
    });

    currentPage = 1;
    renderTable(filtered);
  }

  function renderTable(data) {
    const results = document.getElementById("results");
    const pagination = document.getElementById("pagination");

    if (data.length === 0) {
      results.innerHTML = `<div style="text-align:center; margin:40px 0; font-size:16px; color:#777;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      pagination.innerHTML = "";
      return;
    }

    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageData = data.slice(start, end);
    window.currentData = data;

    let html = "";

    if (window.innerWidth <= 600) {
      /* ëª¨ë°”ì¼ ì¹´ë“œ ë·° */
      html = `<div class="card-list">`;
      pageData.forEach((item, idx) => {
        const imageURL = getMainImageUrl(item["Image URL"]);
        const imageBlock = imageURL
          ? `<div class="card-image" onclick="showDetails(${start + idx})"><img src="${imageURL}" alt="ì•¨ë²” ì´ë¯¸ì§€" loading="lazy"></div>`
          : `<div class="card-image" onclick="showDetails(${start + idx})"><span style="color:#aaa;font-size:12px;">NO IMAGE</span></div>`;
        html += `
          <div class="card-item">
            ${imageBlock}
            <div class="card-content">
              <div><strong>${item.Artist || ""}</strong> - ${item.Title || ""}</div>
              <div>${item.Pressing || ""}</div>
              <div>${item["Condition Jacket"] || ""} / ${item["Condition Media"] || ""}</div>
              <div><strong>â‚©${Number(item["Selling at"] || 0).toLocaleString()}</strong></div>
            </div>
          </div>`;
      });
      html += `</div>`;
    } else {
      /* ë°ìŠ¤í¬í†± í…Œì´ë¸” ë·° */
      html = `<div class="table-wrapper"><table><thead><tr>`;
      displayOrder.forEach(key => { html += `<th>${allDisplayNames[key] || key}</th>`; });
      html += `</tr></thead><tbody>`;

      pageData.forEach((row, idx) => {
        html += `<tr>`;
        displayOrder.forEach(key => {
          if (key === "Image") {
            const imageURL = getMainImageUrl(row["Image URL"]);
            const imgHtml = imageURL
              ? `<div class="table-image" onclick="showDetails(${start + idx})"><img src="${imageURL}" alt="ì´ë¯¸ì§€" loading="lazy"></div>`
              : `<div class="table-image" onclick="showDetails(${start + idx})"><span class="no-image">NO IMAGE</span></div>`;
            html += `<td class="image-cell">${imgHtml}</td>`;
            return;
          }
          let cell = row[key] ?? "";
          if (key === "Selling at" && !isNaN(cell)) cell = Number(cell).toLocaleString();
          if (key === "Details") cell = `<button onclick="showDetails(${start + idx})">ìƒì„¸</button>`;
          html += `<td>${cell}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table></div>`;
    }

    results.innerHTML = html;
    renderPagination(data.length);
  }

  /* ìƒì„¸ ëª¨ë‹¬ */
  window.showDetails = function(index) {
    const item = window.currentData[index];
    const modal = document.getElementById("detailModal");
    const body = document.getElementById("modalBody");

    const title = `${item["Artist"] || ""} - ${item["Title"] || ""}`;
    const ref = item["Ref"] || "";

    let content = `<h4 style="margin-top: 0;">${title}</h4><p style="margin-top: -8px;">${ref}</p>`;

    /* ì´ë¯¸ì§€ */
    const mainImg = getMainImageUrl(item["Image URL"]);
    if (mainImg) {
      content += `<p><strong>ì´ë¯¸ì§€:</strong><br><img src="${mainImg}" alt="ì´ë¯¸ì§€" style="max-width: 100%; margin: 10px 0;" loading="lazy"></p>`;
    }

    /* ì •ë³´ ë¸”ë¡ */
    const store   = item.OriginSheet || "";
    const pressing = item.Pressing || "";
    const jacket  = item["Condition Jacket"] || "";
    const media   = item["Condition Media"] || "";
    const comment = item["Condition Comment"] || "";
    const priceN  = Number(item["Selling at"] || 0);
    const price   = isNaN(priceN) ? "" : priceN.toLocaleString();

    let info = `<div class="info-block">`;
    if (store)   info += `<p><strong>Store :</strong> ${store}</p>`;
    if (pressing)info += `<p><strong>Pressing :</strong> ${pressing}</p>`;
    if (jacket || media) info += `<p><strong>Jacket:</strong> ${jacket || "-"} <strong>/ Media:</strong> ${media || "-"}</p>`;
    if (comment) info += `<p>â—${comment}</p>`;
    if (price)   info += `<p><strong>Price :</strong> ${price}</p>`;
    info += `</div>`;
    content += info;

    /* YouTube */
    if (item.Youtube?.trim()) {
      const url = item.Youtube.trim();
      let embedUrl = "";
      if (url.includes("youtube.com/watch?v=")) {
        embedUrl = `https://www.youtube.com/embed/${url.split("v=")[1].split("&")[0]}`;
      } else if (url.includes("youtu.be/")) {
        embedUrl = `https://www.youtube.com/embed/${url.split("youtu.be/")[1].split("?")[0]}`;
      }
      if (embedUrl) {
        content += `<p><strong>YouTube:</strong><br><div class="video-wrapper"><iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe></div></p>`;
      }
    }

    /* Tracklist */
    if (item.Tracklist?.trim()) {
      const list = item.Tracklist.split("â€¢").map(s => s.trim()).filter(Boolean);
      if (list.length) {
        content += `<p><strong>Tracklist:</strong><ul>${list.map(track => `<li>${track}</li>`).join('')}</ul></p>`;
      }
    }

    /* Credits */
    if (item.Credits?.trim()) {
      const credits = item.Credits.split("â€¢").map(s => s.trim()).filter(Boolean);
      if (credits.length) {
        content += `<p><strong>Credits:</strong><br>${credits.join("<br>")}</p>`;
      }
    }

    content += `<div style="text-align: right; margin-top: 20px;">
      <button onclick="addToCart(${index})" style="background-color: #0071e3; color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 14px;">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
    </div>`;

    body.innerHTML = content;
    modal.style.display = "flex";
  };

  document.getElementById("modalClose").onclick = () => {
    document.getElementById("detailModal").style.display = "none";
  };
  window.onclick = e => {
    if (e.target === document.getElementById("detailModal"))
      document.getElementById("detailModal").style.display = "none";
  };

  document.getElementById("searchInput").addEventListener("keydown", e => {
    if (e.key === "Enter") { e.target.blur(); filterAndRenderTable(); }
  });
  document.getElementById("searchBtn").addEventListener("click", () => {
    document.getElementById("searchInput").blur(); filterAndRenderTable();
  });
  document.getElementById("storeFilter").addEventListener("change", filterAndRenderTable);
  document.getElementById("genreFilter").addEventListener("change", filterAndRenderTable);
  document.getElementById("searchScope").addEventListener("change", filterAndRenderTable);

  document.addEventListener("keydown", e => {
    if (e.key === "Escape") {
      document.getElementById("detailModal").style.display = "none";
    }
  });

  function debounce(func, delay = 300) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  window.addEventListener("resize", debounce(() => {
    if (window.currentData?.length > 0) { renderTable(window.currentData); }
    else { filterAndRenderTable(); }
  }, 300));

  function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const pagination = document.getElementById("pagination");
    let html = "";

    if (totalPages <= 1) { pagination.innerHTML = ""; return; }

    html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Â« ì´ì „</button>`;
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
        html += `<button onclick="goToPage(${i})" ${i === currentPage ? 'disabled' : ''}>${i}</button>`;
      } else if ((i === 2 && currentPage - 3 > 1) || (i === totalPages - 1 && currentPage + 3 < totalPages)) {
        html += `<span style="margin:0 4px;">...</span>`;
      }
    }
    html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ë‹¤ìŒ Â»</button>`;
    pagination.innerHTML = html;
  }

  function goToPage(page) {
    currentPage = page;
    renderTable(window.currentData);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  /* ì¥ë°”êµ¬ë‹ˆ ë¡œì§ */
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("viewCartBtn").onclick = renderCartModal;

    document.getElementById("cartModalClose").onclick = () => {
      document.getElementById("cartModal").style.display = "none";
    };
    window.addEventListener("click", e => {
      if (e.target === document.getElementById("cartModal")) {
        document.getElementById("cartModal").style.display = "none";
      }
    });
  });

  function renderCartModal() {
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const cartBody = document.getElementById("cartBody");

    if (cart.length === 0) {
      cartBody.innerHTML = `<p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>`;
    } else {
      let total = 0;
      const itemsHtml = cart.map((item, idx) => {
        total += Number(item.price || 0);
        return `<div style="margin-bottom: 12px;">
  <input type="checkbox" class="cart-item-checkbox" data-index="${idx}" style="margin-right: 6px;">
  <strong>${idx + 1}. [${item.ref}] ${item.artist} â€“ ${item.title}</strong><br>
  <span style="font-size: 14px;">
    ${item.jacket} / ${item.media} / ${item.pressing}<br>
    ì§„ì—´ ìœ„ì¹˜: ${item.subcategory || "-"}<br>
    ë§¤ì¥: ${item.store}<br>
    ê°€ê²©: â‚©${Number(item.price || 0).toLocaleString()}
  </span>
</div>`;
      }).join('');

      /* âœ… ì¸ì‡„ ë²„íŠ¼ì„ ì™¼ìª½(ì¹´ì¹´ì˜¤ ì™¼ìª½)ìœ¼ë¡œ ì´ë™ */
      cartBody.innerHTML = `
${itemsHtml}
<hr>
<p><strong>ì´ ${cart.length}ê°œ (í•©ê³„: â‚©${total.toLocaleString()})</strong></p>
<div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-top:16px;">
  <div>
    <button onclick="printCart()" style="background:#0071e3; margin-right:10px;">ğŸ–¨ ì¸ì‡„í•˜ê¸°</button>
    <button onclick="window.open('https://pf.kakao.com/_xxx/chat', '_blank')">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜</button>
  </div>
  <div>
    <button id="deleteSelectedBtn" onclick="deleteSelectedCartItems()" style="background:#ccc; color:#000; margin-right: 10px;" disabled>ğŸ—‘ ì„ íƒ í•­ëª© ì‚­ì œ</button>
    <button onclick="clearCart()" style="background:#ccc; color:#000;">âŒ ì „ì²´ ë¹„ìš°ê¸°</button>
  </div>
</div>
`;
      monitorCartCheckboxes();
    }

    document.getElementById("cartModal").style.display = "flex";
  }

  function clearCart() {
    if (confirm("ì¥ë°”êµ¬ë‹ˆë¥¼ ëª¨ë‘ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      localStorage.removeItem("cart");
      document.getElementById("cartModal").style.display = "none";
      alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.");
    }
  }

  function addToCart(index) {
    const item = window.currentData[index];
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");

    const exists = cart.some(c => c.ref === item.Ref);
    if (exists) { alert("ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆì…ë‹ˆë‹¤."); return; }

    const price = Number(item["Selling at"] || 0);
    const newItem = {
      ref: item.Ref || "",
      artist: item.Artist || "",
      title: item.Title || "",
      jacket: item["Condition Jacket"] || "",
      media: item["Condition Media"] || "",
      pressing: item.Pressing || "",
      subcategory: item.Subcategory || item["Subcategory"] || "",
      price: price,
      store: item.OriginSheet || ""
    };

    cart.push(newItem);
    localStorage.setItem("cart", JSON.stringify(cart));
    alert("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function deleteSelectedCartItems() {
    const checkboxes = document.querySelectorAll(".cart-item-checkbox:checked");
    if (checkboxes.length === 0) { alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
    if (!confirm("ì„ íƒí•œ í•­ëª©ì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí• ê¹Œìš”?")) return;

    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const updatedCart = cart.filter((_, idx) => {
      return !Array.from(checkboxes).some(cb => Number(cb.dataset.index) === idx);
    });

    localStorage.setItem("cart", JSON.stringify(updatedCart));
    alert("ì„ íƒí•œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    renderCartModal(); // ë‹¤ì‹œ ë¡œë“œ
  }

  function monitorCartCheckboxes() {
    const checkboxes = document.querySelectorAll(".cart-item-checkbox");
    const deleteBtn = document.getElementById("deleteSelectedBtn");
    if (!deleteBtn) return;

    const updateDeleteButtonState = () => {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      deleteBtn.disabled = !anyChecked;
    };
    checkboxes.forEach(cb => { cb.addEventListener("change", updateDeleteButtonState); });
    updateDeleteButtonState();
  }

  /* ì¸ì‡„ìš© HTML ìƒì„± & ì¶œë ¥ */
  function printCart() {
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    if (cart.length === 0) { alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤."); return; }

    ensurePrintCSS();

    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const hh = String(now.getHours()).padStart(2, '0');
    const mi = String(now.getMinutes()).padStart(2, '0');

    const header = `
      <div class="r-title">MOSAIC PICK LIST</div>
      <div class="r-meta mono">${yyyy}-${mm}-${dd} ${hh}:${mi} | ì´ ${cart.length}ê°œ</div>
      <div class="cut"></div>
    `;

    const items = cart.map((it, i) => {
      const priceStr = Number(it.price || 0).toLocaleString();
      return `
        <div class="item">
          <div class="line1">#${i+1} [${it.ref}] ${it.artist} â€“ ${it.title}</div>
          ${it.pressing ? `<div>Pressing : ${it.pressing}</div>` : ``}
          <div>Jacket : ${it.jacket || '-'} / Media : ${it.media || '-'}</div>
          <div>Subcategory : ${it.subcategory || '-'}</div>
          <div class="price">Price : â‚©${priceStr}</div>
        </div>
        <div class="cut"></div>
      `;
    }).join('');

    const footer = `<div class="foot mono">â€» ë§¤ì¥ ì§„ì—´ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒí’ˆì„ ì°¾ì•„ì£¼ì„¸ìš”.</div>`;

    const printArea = document.getElementById('printArea');
    printArea.innerHTML = header + items + footer;

    /* âœ… ì§§ì€ ì§€ì—° í›„ ì¸ì‡„(ë¹ˆ ì¸ì‡„ ë°©ì§€) */
    setTimeout(() => {
      window.print();
    }, PRINT_DELAY_MS);
  }
  </script>

  <!-- ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë³´ê¸° ë²„íŠ¼ (ë°ìŠ¤í¬í†± ì „ìš©) -->
  <button id="viewCartBtn" style="
    position: fixed;
    bottom: 80px;
    right: 30px;
    z-index: 100;
    padding: 10px 16px;
    font-size: 14px;
    background-color: #0071e3;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  ">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</button>

  <!-- ì¥ë°”êµ¬ë‹ˆ ëª¨ë‹¬ -->
  <div id="cartModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <span id="cartModalClose" class="modal-close">&times;</span>
      <div id="cartBody"></div>
    </div>
  </div>

  <!-- FAB ë©”ë‰´ (ëª¨ë°”ì¼ ì „ìš©) -->
  <div class="fab-menu">
    <button class="fab-main" onclick="document.querySelector('.fab-menu').classList.toggle('open')" aria-label="FAB ë©”ë‰´ ì—´ê¸°">ï¼‹</button>
    <div class="fab-actions">
      <button class="fab-action" onclick="window.scrollTo({ top: 0, behavior: 'smooth' }); document.querySelector('.fab-menu').classList.remove('open')">TOP</button>
      <button class="fab-action" onclick="document.getElementById('viewCartBtn').click(); document.querySelector('.fab-menu').classList.remove('open')">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</button>
    </div>
  </div>

  <!-- ğŸ”’ ì¸ì‡„ ì „ìš© ì˜ì—­(í™”ë©´ì— í‘œì‹œë˜ì§€ ì•ŠìŒ) -->
  <div id="printArea" style="display:block; position:absolute; left:-9999px; top:-9999px;"></div>
</body>
</html>
