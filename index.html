<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MOSAIC 재고 검색</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fafafa;
      color: #1f1f1f;
    }
    h1 {
      text-align: center;
      margin: 30px 0 10px;
      font-size: 28px;
      font-weight: 600;
    }
    .search-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 0 5% 30px;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    select, input[type="text"], button {
      font-size: 16px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    input[type="text"]:focus, select:focus {
      border-color: #0071e3;
      box-shadow: 0 0 0 3px rgba(0,113,227,0.2);
    }
    button {
      background-color: #333;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background-color: #555;
    }
    .table-wrapper {
      overflow-x: auto;
      margin: 0 auto 60px;
      width: 95%;
      animation: fadeIn 0.4s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f7f7f7;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    tbody tr:nth-child(odd) { background-color: #fcfcfc; }
    tbody tr:hover { background-color: #eef6ff; }
    .top-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 99;
      background-color: #333;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .top-button:hover { background-color: #555; }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
.modal-content {
  background: #fff;
  padding: 24px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  border-radius: 10px;
  position: relative;
  animation: slideUp 0.3s ease forwards;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

#modalBody h4 {
  font-size: 18px;
  margin-bottom: 4px;
}
#modalBody p {
  font-size: 14px;
  margin-bottom: 12px;
  line-height: 1.5;
}
#modalBody ul {
  padding-left: 18px;
  margin: 0 0 12px 0;
}
#modalBody li {
  font-size: 14px;
  line-height: 1.4;
  margin-bottom: 4px;
}
#modalBody strong {
  color: #222;
}

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      transition: color 0.3s;
    }
    .modal-close:hover { color: #000; }
    .video-wrapper {
      position: relative;
      padding-top: 56.25%;
      height: 0;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .video-wrapper iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    @media (max-width: 600px) {
      table { display: none; }
      .card-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 0 5%;
      }
      .card-item {
        display: flex;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      }
      .card-item .card-image {
        width: 100px;
        height: 100px;
        background-color: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .card-item .card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .card-content {
        padding: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .card-content div {
        margin-bottom: 4px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h1>MOSAIC 재고 검색</h1>
  <div class="search-wrapper">
    <div class="filters">
      <select id="storeFilter">
        <option value="all">매장 전체</option>
        <option value="WEST">WEST</option>
        <option value="EAST">EAST</option>
      </select>
      <select id="genreFilter"><option value="all">장르 전체</option></select>
      <select id="searchScope">
        <option value="all">전체검색</option>
        <option value="Artist">아티스트</option>
        <option value="Title">타이틀</option>
        <option value="Label">레이블</option>
        <option value="Tracklist">트랙리스트</option>
        <option value="Credits">크레딧</option>
      </select>
      <input type="text" id="searchInput" placeholder="검색어 입력" />
      <button id="searchBtn">검색</button>
    </div>
  </div>
  <div id="results"></div>
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <span id="modalClose" class="modal-close">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>
  <button class="top-button" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">TOP</button>
  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxlZuzYrg1A76VGHn1h6SeFmGcJpXhOAid15mDoW7mKphngixFSTYwwW5zfZIyNYDmdRg/exec";
    const displayOrder = ["Artist", "Title", "Label", "Pressing", "Genre", "Style", "Subcategory", "Condition Jacket", "Condition Media", "Selling at", "Details"];
    const allDisplayNames = {
      "Ref": "상품번호", "Artist": "아티스트", "Title": "타이틀",
      "Label": "레이블", "Pressing": "프레싱", "Genre": "장르", "Style": "스타일",
      "Subcategory": "진열 위치", "Condition Jacket": "자켓", "Condition Media": "미디어",
      "Selling at": "가격", "Details": "상세", "Youtube": "YouTube"
    };

    let allData = [];

    fetch(SHEET_URL)
      .then(res => res.json())
      .then(data => {
        allData = data;
        populateGenreFilter(data);
        filterAndRenderTable();
      });

    function populateGenreFilter(data) {
      const genreSelect = document.getElementById("genreFilter");
      const genreSet = new Set();
      data.forEach(item => {
        const genre = item["Genre"];
        if (genre) genreSet.add(genre.trim());
      });
      genreSelect.innerHTML = `<option value="all">장르 전체</option>`;
      [...genreSet].sort().forEach(genre => {
        const option = document.createElement("option");
        option.value = genre;
        option.textContent = genre;
        genreSelect.appendChild(option);
      });
    }

    function filterAndRenderTable() {
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      const scope = document.getElementById("searchScope").value;
      const selectedStore = document.getElementById("storeFilter").value;
      const selectedGenre = document.getElementById("genreFilter").value;

      const filtered = allData.filter(item => {
        const store = String(item.OriginSheet ?? "").trim();
        const genre = String(item["Genre"] ?? "").trim();
        if (selectedStore !== "all" && store !== selectedStore) return false;
        if (selectedGenre !== "all" && genre !== selectedGenre) return false;

        const artist = String(item["Artist"] ?? "").toLowerCase();
        const title = String(item["Title"] ?? "").toLowerCase();
        const label = String(item["Label"] ?? "").toLowerCase();
        const tracklist = String(item["Tracklist"] ?? "").toLowerCase();
        const credits = String(item["Credits"] ?? "").toLowerCase();

        switch (scope) {
          case "Artist": return artist.includes(keyword);
          case "Title": return title.includes(keyword);
          case "Label": return label.includes(keyword);
          case "Tracklist": return tracklist.includes(keyword);
          case "Credits": return credits.includes(keyword);
          default:
            return (
              artist.includes(keyword) ||
              title.includes(keyword) ||
              label.includes(keyword) ||
              tracklist.includes(keyword) ||
              credits.includes(keyword)
            );
        }
      });

      renderTable(filtered);
    }

    function renderTable(data) {
      const results = document.getElementById("results");
      window.currentData = data;

      if (window.innerWidth <= 600) {
        let html = `<div class="card-list">`;
        data.forEach((item, idx) => {
          const imageURL = item["Image URL"]?.trim();
          const imageBlock = imageURL
            ? `<div class="card-image" onclick="showDetails(${idx})"><img src="${imageURL}" alt="앨범 이미지"></div>`
            : `<div class="card-image" onclick="showDetails(${idx})"><span style="color:#aaa;font-size:12px;">NO IMAGE</span></div>`;
          html += `
            <div class="card-item">
              ${imageBlock}
              <div class="card-content">
                <div><strong>${item.Artist || ""}</strong> - ${item.Title || ""}</div>
                <div>${item.Pressing || ""}</div>
                <div>${item["Condition Jacket"] || ""} / ${item["Condition Media"] || ""}</div>
                <div><strong>₩${Number(item["Selling at"] || 0).toLocaleString()}</strong></div>
              </div>
            </div>`;
        });
        html += `</div>`;
        results.innerHTML = html;
      } else {
        let html = `<div class="table-wrapper"><table><thead><tr>`;
        displayOrder.forEach(key => html += `<th>${allDisplayNames[key] || key}</th>`);
        html += `</tr></thead><tbody>`;
        data.forEach((row, idx) => {
          html += `<tr>`;
          displayOrder.forEach(key => {
            let cell = row[key] ?? "";
            if (key === "Selling at" && !isNaN(cell)) cell = Number(cell).toLocaleString();
            if (key === "Details") cell = `<button onclick="showDetails(${idx})">상세</button>`;
            html += `<td>${cell}</td>`;
          });
          html += `</tr>`;
        });
        html += `</tbody></table></div>`;
        results.innerHTML = html;
      }
    }

    window.showDetails = function(index) {
      const item = window.currentData[index];
      const modal = document.getElementById("detailModal");
      const body = document.getElementById("modalBody");

      const title = `${item["Artist"] || ""} - ${item["Title"] || ""}`;
      const ref = item["Ref"] || "";

      let content = `<h4 style="margin-top: 0;">${title}</h4><p style="margin-top: -8px;">${ref}</p>`;

      if (item["Image URL"]?.trim()) {
        content += `<p><strong>이미지:</strong><br><img src="${item["Image URL"].trim()}" alt="이미지" style="max-width: 100%; margin: 10px 0;" loading="lazy"></p>`;
      }

      content += `<p><strong>컨디션 코멘트:</strong><br>${item["Condition Comment"] || "없음"}</p>`;

      if (item["Youtube"]?.trim()) {
        const url = item["Youtube"].trim();
        let embedUrl = "";
        if (url.includes("youtube.com/watch?v=")) {
          embedUrl = `https://www.youtube.com/embed/${url.split("v=")[1].split("&")[0]}`;
        } else if (url.includes("youtu.be/")) {
          embedUrl = `https://www.youtube.com/embed/${url.split("youtu.be/")[1].split("?")[0]}`;
        }
        if (embedUrl) {
          content += `<p><strong>YouTube:</strong><br><div class="video-wrapper"><iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe></div></p>`;
        }
      }

      if (item.Tracklist?.trim()) {
        const list = item.Tracklist.split("•").map(s => s.trim()).filter(Boolean);
        if (list.length) {
          content += `<p><strong>Tracklist:</strong><ul>${list.map(track => `<li>${track}</li>`).join('')}</ul></p>`;
        }
      }

      if (item.Credits?.trim()) {
        const credits = item.Credits.split("•").map(s => s.trim()).filter(Boolean);
        if (credits.length) {
          content += `<p><strong>Credits:</strong><br>${credits.join("<br>")}</p>`;
        }
      }

      body.innerHTML = content;
      modal.style.display = "flex";
    };

    document.getElementById("modalClose").onclick = () =>
      document.getElementById("detailModal").style.display = "none";

    window.onclick = e => {
      if (e.target === document.getElementById("detailModal"))
        document.getElementById("detailModal").style.display = "none";
    };

document.getElementById("searchInput").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.target.blur();
    filterAndRenderTable();
  }
});

document.getElementById("searchBtn").addEventListener("click", () => {
  document.getElementById("searchInput").blur();
  filterAndRenderTable();
});

document.getElementById("storeFilter").addEventListener("change", filterAndRenderTable);
document.getElementById("genreFilter").addEventListener("change", filterAndRenderTable);
document.getElementById("searchScope").addEventListener("change", filterAndRenderTable);

document.addEventListener('keydown', (e) => {
  if (e.key === "Escape") {
    document.getElementById("detailModal").style.display = "none";
  }
});

    function debounce(func, delay = 300) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }
   window.addEventListener("resize", debounce(() => {
  if (window.currentData?.length > 0) {
    renderTable(window.currentData);
  } else {
    filterAndRenderTable();
  }
}, 300));
  </script>
</body>
</html>
